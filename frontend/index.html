<script>
window.addEventListener('DOMContentLoaded', () => {

const API = "/planets";
const qs = s => document.querySelector(s);
const F = {
  id: qs('#id'),
  name: qs('#name'),
  system: qs('#system'),
  climate: qs('#climate'),
  population: qs('#population'),
  surfaceType: qs('#surfaceType')
};
const rows = qs('#rows');
const crudSection = document.querySelector('.controls').parentElement;
const tableSection = document.querySelector('table');
let token = localStorage.getItem('token') || '';

function updateUI(loggedIn) {
  crudSection.style.display = loggedIn ? 'block' : 'none';
  tableSection.style.display = loggedIn ? 'table' : 'none';
}

updateUI(!!token);

// --- LOGIN ---
document.querySelector('#btnLogin').onclick = async () => {
  const r = await fetch('/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      login: document.querySelector('#login').value,
      password: document.querySelector('#password').value
    })
  });
  const data = await r.json();
  if (r.ok) {
    token = data.token;
    localStorage.setItem('token', token);
    alert('âœ… Logged in!');
    updateUI(true);
    list();
  } else alert(data.error);
};

// --- LOGOUT ---
document.querySelector('#btnLogout').onclick = () => {
  localStorage.removeItem('token');
  token = '';
  updateUI(false);
  rows.innerHTML = '<tr><td colspan="7">Please log in</td></tr>';
};

// --- LIST ---
async function list() {
  const r = await fetch(API, {
    headers: { 'Authorization': 'Bearer ' + token }
  });

  if (!r.ok) {
    console.error('Server returned', r.status);
    rows.innerHTML = '<tr><td colspan="7">Error loading planets (status ' + r.status + ')</td></tr>';
    return;
  }

  if (r.status === 401) {
    rows.innerHTML = '<tr><td colspan="7">Please log in</td></tr>';
    updateUI(false);
    return;
  }

  const data = await r.json();
  rows.innerHTML = data.map(p => `
    <tr>
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.system}</td>
      <td>${p.climate}</td>
      <td>${p.population}</td>
      <td>${p.surfaceType}</td>
      <td>
        <button onclick="editP(${p.id})">Edit</button>
        <button onclick="delP(${p.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

// --- CRUD ---
window.editP = async (id) => {
  const r = await fetch(`${API}/${id}`, { headers: { 'Authorization': 'Bearer ' + token }});
  if (!r.ok) { alert('Planet not found'); return; }
  const p = await r.json();
  Object.keys(F).forEach(k => F[k].value = p[k] || '');
};

window.delP = async (id) => {
  if (!confirm('Delete this planet?')) return;
  const r = await fetch(`${API}/${id}`, {
    method: 'DELETE',
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (r.ok) list(); else alert('Delete failed');
};

qs('#save').onclick = async () => {
  const body = JSON.stringify({
    name: F.name.value.trim(),
    system: F.system.value.trim(),
    climate: F.climate.value.trim(),
    population: Number(F.population.value),
    surfaceType: F.surfaceType.value.trim()
  });
  const id = F.id.value;
  const r = await fetch(id ? `${API}/${id}` : API, {
    method: id ? 'PUT' : 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body
  });
  if (r.ok) { reset(); list(); }
  else {
    const e = await r.json();
    alert(e.error || 'Error occurred');
  }
};

function reset() { Object.values(F).forEach(i => i.value = ''); }
qs('#reset').onclick = reset;

if (token) list();

});
</script>